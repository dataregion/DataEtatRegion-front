<div class="fr-container--fluid fr-container ">
    <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--center">
        <div class="fr-col-12 fr-col-md-10 fr-col-lg-8">
            <div class="fr-container  fr-px-md-0 fr-pt-10v fr-pt-md-14v fr-pb-6v fr-pb-md-10v">

                <form [formGroup]="form" aria-label="Formulaire de chargement national">
                    <fieldset class="fr-fieldset">
                        <legend class="fr-fieldset__legend" id="text-legend">
                            Charger les fichiers financiers nationaux
                        </legend>

                        <div class="fr-fieldset__element fr-fieldset__element--year">
                            <div class="fr-input-group ">
                                <label class="fr-label" for="year">
                                    Année
                                </label>
                                <select class="fr-select" id="year" formControlName="year">
                                    @for(year of years; track year) {
                                    <option [value]="year">{{ year }}</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="fr-fieldset__element">
                            <div class="fr-upload-group">
                                <label class="fr-label" for="fileUploadAe">
                                    Fichier Engagements (AE)
                                </label>
                                <input #fileUploadAe id="fileUploadAe" (change)="onFileAeChange($event)" [accept]="requiredFileType"
                                    class="fr-upload" type="file" />
                                <div class="fr-messages-group"></div>
                            </div>

                        </div>


                        <div class="fr-fieldset__element">
                            <div class="fr-upload-group">
                                <label class="fr-label" for="fileUploadCp">Fichier Montants payés (CP)</label>
                                <input #fileUploadCp id="fileUploadCp" (change)="onFileCpChange($event)" [accept]="requiredFileType"
                                    class="fr-upload" type="file" />
                                <div class="fr-messages-group"></div>
                            </div>
                        </div>
                    </fieldset>
                    <button data-fr-opened="false" aria-controls="confirmUploadModal" type="button"
                        [disabled]="!form.valid || !fileFinancialAe || !fileFinancialCp || uploadInProgress()"
                        aria-label="Charger les données financières nationales" class="fr-btn">
                        @if (uploadInProgress()) {
                            <span class="fr-spinner fr-spinner--sm" aria-label="Chargement…" role="status"></span>
                            Traitement en cours...
                        } @else {
                            Charger
                        }
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modale de confirmation DSFR -->
<dialog #confirmUploadModal id="confirmUploadModal" class="fr-modal"
    [attr.data-fr-concealing-backdrop]="uploadInProgress() ? 'false' : null"
    aria-labelledby="confirmer le chargement des fichiers" aria-modal="true">
    <div class="fr-container fr-container--fluid fr-container-sm">
        <div class="fr-grid-row fr-grid-row--center">
            <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                <div class="fr-modal__body">
                    <div class="fr-modal__header">
                        <button aria-controls="confirmUploadModal" title="Fermer" type="button"
                            class="fr-btn--close fr-btn">
                            Fermer
                        </button>
                    </div>

                    <div class="fr-modal__content">
                        <h2 id="confirm-modal-title" class="fr-modal__title">
                            <span class="fr-icon-warning-line fr-icon--lg" aria-hidden="true"></span>
                            Confirmer le chargement
                        </h2>
                        <p>
                            Êtes-vous sûr de vouloir charger les données financières pour l'année <strong>{{
                                form.get('year')!.value }}</strong> ?
                        </p>
                        <p class="fr-text--sm">
                            Cette action va remplacer les données existantes pour cette année.
                        </p>
                    </div>

                    <div class="fr-modal__footer">
                        <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                            <li> 
                                <button type="button" aria-controls="confirmUploadModal"
                                    class="fr-btn fr-btn--secondary">
                                    Annuler
                                </button>
                            </li>
                            <li>
                                 <button type="button" (click)="uploadFiles()" aria-controls="confirmUploadModal" class="fr-btn">
                                    Confirmer le chargement
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</dialog>