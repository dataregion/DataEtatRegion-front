.x-image: &image
  image: node:22.13.1@sha256:ae2f3d4cc65d251352eca01ba668824f651a2ee4d2a37e2efb22649521a483fd

variables:
  NPM_CI_CMD: "npm ci --prefer-offline --quiet"

"ðŸ”¨ npm ci":
  <<: *image
  stage: ðŸ”¨ build
  script:
    - |
      set -x
      if [ ! -d "./node_modules" ]; then
        echo >&2 'node_modules cache not available. run ci.'
        ${NPM_CI_CMD}
      fi
  cache:
    key:
      files:
        - package-lock.json
        - package.json
    paths:
      - node_modules/
    policy: pull-push

".ðŸ”¨ build angular app":
  <<: *image
  stage: ðŸ”¨ build
  cache:
    key:
      files:
        - package-lock.json
        - package.json
    paths:
      - node_modules/
    policy: pull
  before_script:
    - |
      set -x
      if [ ! -d "./node_modules" ]; then
        echo >&2 'node_modules cache not available. run ci.'
        ${NPM_CI_CMD}
      fi
      npm run lint
      set +x
  rules:
    - if: '$DO_BUILD == "âœ…"'
    - when: never
  needs:
    - job: "ðŸ”¨ npm ci"

"ðŸ”¨ build financial app":
  extends: ".ðŸ”¨ build angular app"
  script:
    - npm run build:financial-data
  artifacts:
    expire_in: 30 mins
    paths:
      - dist/financial-data

"ðŸ”¨ build france-relance app":
  extends: ".ðŸ”¨ build angular app"
  script:
    - npm run build:france-relance
  artifacts:
    expire_in: 30 mins
    paths:
      - dist/france-relance
  needs: # XXX: to ensure cache is available (not available for parallel jobs I dunno why)
    - job: "ðŸ”¨ build financial app" 
  dependencies: []

"ðŸ”¨ build data-qpv app":
  extends: ".ðŸ”¨ build angular app"
  script:
    - npm run build:data-qpv
  artifacts:
    expire_in: 30 mins
    paths:
      - dist/data-qpv
  needs: # XXX: to ensure cache is available (not available for parallel jobs I dunno why)
    - job: "ðŸ”¨ build france-relance app"
  dependencies: []